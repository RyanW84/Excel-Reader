using System.Globalization;
using ExcelReader.RyanW84.Controller;
using ExcelReader.RyanW84.Services;
using Spectre.Console;

namespace ExcelReader.RyanW84.UserInterface;

public class ExcelUserInputUI
{
    public ExcelWriteController Controller { get; }
    public AnyExcelRead AnyExcelRead { get; }

    public ExcelUserInputUI(ExcelWriteController controller, AnyExcelRead anyExcelRead)
    {
        Controller = controller;
        AnyExcelRead = anyExcelRead;
    }

    public string GetFilePath(string defaultPath)
    {
        return AnsiConsole.Ask<string>(
            "\nEnter the path to the Excel file (or press Enter for default):",
            defaultPath
        );
    }

    public Dictionary<string, string> UpdateFieldValues(Dictionary<string, string> existingFields)
    {
        var fieldValues = new Dictionary<string, string>();
        string? dobValue = existingFields.TryGetValue("DOB", out string? value) ? value : null;
        string? ageFieldName = null;

        AnsiConsole.MarkupLine("[yellow]Review and update Excel fields:[/]");
        foreach (var field in existingFields)
        {
            var fieldName = field.Key;
            var currentValue = field.Value;
            string newValue = currentValue;
            bool update = AnsiConsole.Confirm(
                $"Field: [green]{fieldName}[/] | Current Value: [yellow]{currentValue}[/] | Update?"
            );
            if (update)
            {
                if (fieldName.Equals("Name", StringComparison.OrdinalIgnoreCase))
                {
                    newValue = AnsiConsole.Prompt(
                        new TextPrompt<string>("Enter the updated Name:")
                            .DefaultValue(currentValue)
                            .AllowEmpty()
                    );
                }
                else if (fieldName.Equals("Surname", StringComparison.OrdinalIgnoreCase))
                {
                    newValue = AnsiConsole.Prompt(
                        new TextPrompt<string>("Enter the updated Surname:")
                            .DefaultValue(currentValue)
                            .AllowEmpty()
                    );
                }
                else if (fieldName.Contains("dob", StringComparison.CurrentCultureIgnoreCase))
                {
                    newValue = AnsiConsole.Prompt(
                        new TextPrompt<string>("Enter Date of Birth (dd-MM-yyyy):").Validate(date =>
                            DateTime.TryParseExact(
                                date,
                                "dd-MM-yyyy",
                                CultureInfo.InvariantCulture,
                                DateTimeStyles.None,
                                out _
                            )
                                ? ValidationResult.Success()
                                : ValidationResult.Error("Invalid date format. Use dd-MM-yyyy.")
                        )
                    );
                    dobValue = newValue;
                }
                else if (fieldName.Equals("age", StringComparison.OrdinalIgnoreCase))
                {
                    AnsiConsole.MarkupLine("Age is autocalculated");
                    ageFieldName = fieldName;
                    continue;
                }
                else if (fieldName.Equals("sex", StringComparison.OrdinalIgnoreCase))
                {
                    newValue = AnsiConsole.Prompt(
                        new SelectionPrompt<string>()
                            .Title("Select sex:")
                            .AddChoices("Male", "Female", "Other")
                    );
                }
                else if (fieldName.Equals("colour", StringComparison.OrdinalIgnoreCase))
                {
                    newValue = AnsiConsole.Prompt(
                        new SelectionPrompt<string>()
                            .Title("Select colour:")
                            .AddChoices("White", "Black", "Asian", "African", "Other")
                    );
                }
            }
            fieldValues[fieldName] = newValue;
        }

        // After all fields, recalculate age from DOB if possible, case-insensitive
        ageFieldName ??= existingFields.Keys.FirstOrDefault(k =>
            k.Equals("age", StringComparison.OrdinalIgnoreCase)
        );
        if (ageFieldName != null)
        {
            if (
                !string.IsNullOrEmpty(dobValue)
                && DateTime.TryParseExact(
                    dobValue,
                    "dd-MM-yyyy",
                    CultureInfo.InvariantCulture,
                    DateTimeStyles.None,
                    out var dob
                )
            )
            {
                var today = DateTime.Today;
                var age = today.Year - dob.Year;
                if (dob > today.AddYears(-age))
                    age--;
                fieldValues[ageFieldName] = age.ToString();
                AnsiConsole.MarkupLine($"[green]Calculated age from DOB: {age}[/]");
            }
        }
        return fieldValues;
    }

    public void ExcelGatherInput()
    {
        var filePath = GetFilePath(
            @"C:\Users\Ryanw\OneDrive\Documents\GitHub\Excel-Reader\Data\ExcelDynamic.xlsx"
        );
        var existingFields = Controller.GetExistingFieldValues(filePath);
        if (existingFields == null || existingFields.Count == 0)
        {
            DisplayErrorMessage();
            return;
        }
        var updatedFields = UpdateFieldValues(existingFields);
        Controller.WriteDataToExcel(filePath, updatedFields);
    }

    public void DisplayMessage(string message)
    {
        AnsiConsole.MarkupLine(message);
    }

    public void DisplayError(string message)
    {
        AnsiConsole.MarkupLine($"[red]{message}[/]");
    }

    public void DisplaySuccess(string message)
    {
        AnsiConsole.MarkupLine($"[green]{message}[/]");
    }

    public void DisplayWarning(string message)
    {
        AnsiConsole.MarkupLine($"[yellow]{message}[/]");
    }

    public void DisplayErrorMessage()
    {
        AnsiConsole.MarkupLine("[red]An error occurred while processing the Excel file.[/]");
    }
}
