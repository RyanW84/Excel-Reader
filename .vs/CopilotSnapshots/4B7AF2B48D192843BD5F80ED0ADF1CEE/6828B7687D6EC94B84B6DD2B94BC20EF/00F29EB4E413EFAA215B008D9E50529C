using System.Data;
using ExcelReader.RyanW84.Abstractions;
using ExcelReader.RyanW84.Helpers;
using OfficeOpenXml;

namespace ExcelReader.RyanW84.Services;

public class ReadFromCsv(IFilePathService filePathManager, INotificationService userNotifier)
{
    private readonly IFilePathService _filePathManager = filePathManager;
    private readonly INotificationService _userNotifier = userNotifier;

	public async Task<List<string[]>> ReadCsvFile()
    {
        string filePath;
        try
        {
			var customDefault = @"C:\Users\Ryanw\OneDrive\Documents\GitHub\Excel-Reader\Data\ExcelCSV.CSV";
			filePath = _filePathManager.GetFilePath(FileType.CSV, customDefault);
        }
        catch (FilePathValidationException ex)
        {
            _userNotifier.ShowError($"CSV file path error: {ex.Message}");
            return [];
        }
        _userNotifier.ShowInfo($"Opening {filePath}");

        ExcelPackage.License.SetNonCommercialPersonal("Ryan Weavers");

        var csvData = new List<string[]>();

        using var stream = new FileStream(filePath, FileMode.Open, FileAccess.Read);
        using var reader = new StreamReader(stream);

        string? line;
        while ((line = await reader.ReadLineAsync()) != null)
        {
            var rowData = line.Split(','); // Adjust for your delimiter and quoted values if needed
            csvData.Add(rowData);
        }

        return csvData;
    }

    public static async Task<DataTable> ConvertToDataTableAsync(List<string[]> csvData)
    {
        return await Task.Run(() =>
        {
            var dataTable = new DataTable();

            if (csvData == null || csvData.Count == 0)
                return dataTable;

            // Add columns using the first row as header
            foreach (var columnName in csvData[0])
            {
                dataTable.Columns.Add(columnName ?? string.Empty);
            }

            // Add rows (skip header row)
            for (int i = 1; i < csvData.Count; i++)
            {
                dataTable.Rows.Add(csvData[i]);
            }

            return dataTable;
        });
    }

    // Keep synchronous version for backward compatibility
    public static DataTable ConvertToDataTable(List<string[]> csvData)
    {
        return ConvertToDataTableAsync(csvData).GetAwaiter().GetResult();
    }
}
