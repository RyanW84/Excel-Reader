using ExcelReader.RyanW84.Data;
using ExcelReader.RyanW84.Services;
using ExcelReader.RyanW84.Helpers;
using ExcelReader.RyanW84.Abstractions;

namespace ExcelReader.RyanW84.Controller;

public class CsvController
{
    private readonly ExcelReaderDbContext _dbContext;
    private readonly ReadFromCsv _readFromCsv;
    private readonly CreateTableFromCSV _createTableFromCSV;
    private readonly INotificationService _notificationService;

    public CsvController(ExcelReaderDbContext dbContext, ReadFromCsv readFromCsv, CreateTableFromCSV createTableFromCSV, INotificationService notificationService)
    {
        _dbContext = dbContext;
        _readFromCsv = readFromCsv;
        _createTableFromCSV = createTableFromCSV;
        _notificationService = notificationService;
    }

    public async Task AddDataFromCsv()
    {
        _notificationService.ShowInfo("Starting CSV import...");
        var csvData = await _readFromCsv.ReadCsvFile();
        var dataTable = await ReadFromCsv.ConvertToDataTableAsync(csvData);
        _notificationService.ShowInfo($"Read {dataTable.Rows.Count} Rows from CSV file.");
        _notificationService.ShowInfo($"Read {dataTable.Columns.Count} Columns from CSV file.");

        dataTable.TableName = "CsvImport";
        await _createTableFromCSV.CreateTableFromCsvDataAsync(dataTable);
        await _dbContext.SaveChangesAsync();
        _notificationService.ShowSuccess("CSV import complete.");
    }
}