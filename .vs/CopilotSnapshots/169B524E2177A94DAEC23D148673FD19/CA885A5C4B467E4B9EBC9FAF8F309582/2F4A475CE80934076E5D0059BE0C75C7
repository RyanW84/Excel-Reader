using ExcelReader.RyanW84.Data;
using ExcelReader.RyanW84.Services;
using ExcelReader.RyanW84.Helpers;
using ExcelReader.RyanW84.Abstractions;

namespace ExcelReader.RyanW84.Controller;

public class PdfTableController(
    ExcelReaderDbContext dbContext,
    IPdfTableReader pdfTableReader,
    ICsvTableCreator csvTableCreator,
    INotificationService notificationService)
{
    private readonly ExcelReaderDbContext _dbContext = dbContext;
    private readonly IPdfTableReader _pdfTableReader = pdfTableReader;
    private readonly ICsvTableCreator _csvTableCreator = csvTableCreator;
    private readonly INotificationService _notificationService = notificationService;

    public async Task AddDataFromPdf()
    {
        _notificationService.ShowInfo("Starting PDF import...");
        var pdfData = await _pdfTableReader.ReadPdfFileAsync();
        var dataTable = await ReadFromPdf.ConvertToDataTableAsync(pdfData);
        _notificationService.ShowInfo($"Read {dataTable.Rows.Count} Rows from PDF file.");
        _notificationService.ShowInfo($"Read {dataTable.Columns.Count} Columns from PDF file.");

        dataTable.TableName = "PdfImport";
        await _csvTableCreator.CreateTableFromCsvDataAsync(dataTable);
        await _dbContext.SaveChangesAsync();
        _notificationService.ShowSuccess("PDF import complete.");
    }
}
