// Ignore Spelling: Pdf

using ExcelReader.RyanW84.Abstractions.Common;
using ExcelReader.RyanW84.Abstractions.Services;
using ExcelReader.RyanW84.Helpers;
using ExcelReader.RyanW84.Services;
using ExcelReader.RyanW84.UserInterface;
using ExcelReader.RyanW84.Abstractions.FileOperations.Readers;
using ExcelReader.RyanW84.Abstractions.FileOperations.Writers;
using ExcelReader.RyanW84.Abstractions.Data.DatabaseServices;

namespace ExcelReader.RyanW84.Controller;

public class PdfFormController(
	IPdfFormReader readFromPdfForm,
	IPdfFormWriter writeToPdfForm,
	IPdfFormDatabaseService writePdfFormDataToDatabaseService,
	IFieldInputService fieldInputUi,
	IFilePathService filePathManager,
	INotificationService notificationService
	)
{
    private readonly IPdfFormReader _readFromPdfForm = readFromPdfForm;
    private readonly IPdfFormWriter _writeToPdfForm = writeToPdfForm;
    private readonly IPdfFormDatabaseService _writePdfFormDataToDatabaseService = writePdfFormDataToDatabaseService;
    private readonly IFieldInputService _fieldInputUi = fieldInputUi;
    private readonly IFilePathService _filePathManager = filePathManager;
    private readonly INotificationService _notificationService = notificationService;

	public async Task AddOrUpdateDataFromPdfForm()
    {
        // 1. Get the file path using FilePathManager

        string filePath;
        try
        {
            var customDefault =
                @"C:\\Users\\Ryanw\\OneDrive\\Documents\\GitHub\\Excel-Reader\\Data\\FillablePDF.pdf";
            filePath = _filePathManager.GetFilePath(FileType.PDF, customDefault);
        }
        catch (FilePathValidationException ex)
        {
            _notificationService.ShowError($"PDF file path error: {ex.Message}");
            return;
        }

        // 2. Read existing fields from PDF
        var fields = await _readFromPdfForm.ReadFormFieldsAsync(filePath);
        if (fields.Count == 0)
        {
            _notificationService.ShowError("No form fields found or file not found.");
            return;
        }

        // 3. Pass fields to unified UI for user to update
        // Async usage:
        var updatedFields = await _fieldInputUi.GatherUpdatedFieldsAsync(
            fields,
            FileType.PDF
        );

        // Or backward compatible:
        // var updatedFields = _fieldInputUi.GatherUpdatedFields(fields, FieldInputUi.FileType.PDF);

        // 4. Write updated fields back to PDF form
        await _writeToPdfForm.WriteFormFieldsAsync(filePath, updatedFields);

        // 5. Add updated data to the database
        await _writePdfFormDataToDatabaseService.WriteAsync(updatedFields);

        _notificationService.ShowSuccess("PDF form updated and data imported to SQL table.");
    }
}
